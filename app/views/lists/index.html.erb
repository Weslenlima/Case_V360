<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="text-primary fw-bold">Minhas Listas</h2>
  <%= link_to "‚ûï Nova Lista", new_list_path, class: "btn btn-primary" %>
</div>

<% if @lists.any? %>
  <div class="row gy-4">
    <% @lists.each do |list| %>
      <div class="col-md-6 col-lg-4">
        <div class="card p-3 shadow-sm">
          <!-- T√≠tulo e descri√ß√£o -->
          <h5 class="text-dark fw-bold"><%= list.title %></h5>
          <p class="text-muted mb-1"><%= list.description.presence || "Sem descri√ß√£o" %></p>
          <p class="small text-secondary">Criada em <%= list.created_at.strftime("%d/%m/%Y") %></p>

          <!-- Tarefas -->
          <% if list.todos.any? %>
            <ul class="list-unstyled mt-2">
              <% list.todos.order(:due_date).each do |todo| %>
                <li class="d-flex align-items-center mb-1 <%= 'text-decoration-line-through text-muted' if todo.completed %>" id="todo-<%= todo.id %>">
                  <%= check_box_tag "todo_#{todo.id}", todo.id, todo.completed, class: "form-check-input me-2 toggle-todo", data: { url: toggle_list_todo_path(list, todo) } %>
                  <span><%= todo.title %></span>
                  <% if todo.due_date.present? %>
                    <small class="text-muted ms-auto">Prazo: <%= todo.due_date.strftime("%d/%m/%Y") %></small>
                  <% end %>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-muted small mt-2">Nenhuma tarefa ainda.</p>
          <% end %>

          <!-- Bot√µes -->
          <div class="mt-3 d-flex gap-2">
            <%= link_to "‚úèÔ∏è Editar", edit_list_path(list), class: "btn btn-outline-primary btn-sm flex-grow-1" %>
            <%= link_to "üóëÔ∏è Excluir", list_path(list), method: :delete, data: { confirm: "Excluir esta lista?" }, class: "btn btn-outline-danger btn-sm flex-grow-1" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="text-center text-muted mt-5">
    <p>Nenhuma lista criada ainda.</p>
  </div>
<% end %>

<script>
  // Fun√ß√£o para ordenar os <li> de uma lista por data (menor primeiro)
  function sortTodosList(listElement) {
    const todos = Array.from(listElement.querySelectorAll('li'));
    
    todos.sort((a, b) => {
      const smallA = a.querySelector('small') ? a.querySelector('small').textContent.replace('Prazo: ', '') : null;
      const smallB = b.querySelector('small') ? b.querySelector('small').textContent.replace('Prazo: ', '') : null;

      const parseDate = str => {
        if (!str) return new Date(8640000000000000); // data futura se n√£o houver
        const [d,m,y] = str.split('/');
        return new Date(`${y}-${m}-${d}`);
      }

      return parseDate(smallA) - parseDate(smallB);
    });

    todos.forEach(todo => listElement.appendChild(todo));
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Ordena todas as listas inicialmente
    document.querySelectorAll('.card ul').forEach(ul => sortTodosList(ul));

    // Adiciona evento para atualizar via AJAX e reordenar
    document.querySelectorAll('.toggle-todo').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const url = checkbox.dataset.url;
        const listElement = checkbox.closest('ul');

        fetch(url, {
          method: 'PATCH',
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Accept': 'application/javascript'
          }
        }).finally(() => {
          // Reordena a lista ap√≥s atualizar
          sortTodosList(listElement);
        });
      });
    });
  });
</script>
